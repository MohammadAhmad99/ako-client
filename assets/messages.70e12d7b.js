import{h as Q,x as X,u as v,y as Z,d as P,z as ee,o as R,S as te,U as W,w as re,F as ne,G as se,L as ae,I as oe,f as ue,P as B}from"./index-0d696cf9.js";import{r as u,ar as ie,ag as L,J as le}from"./@chakra-ui/icons.bb373c7b.js";import{d as o,m as h,e as f,j as e,H as U,g as ce,h as de,l as H,aj as he,B as me,T as g,ay as F,ab as j,am as fe,aq as z,S as O,a9 as _,u as ge,ag as xe,D as pe,k as Se,a8 as ve}from"./@chakra-ui/react.4d46e3f3.js";import{L as ye}from"./LoadingList.7e2bed80.js";import"./framer-motion.7561cd0c.js";const be=()=>{const t=async()=>{try{return(await X.fetchConversations()).data}catch(s){return Promise.reject(s)}},{execute:r,...n}=Q(t);return u.exports.useEffect(()=>{r()},[]),{...n}},$=u.exports.createContext({search:"",setSearch:()=>{}}),N=()=>{const t=u.exports.useContext($);if(!t)throw new Error("ChatContext was outside of its provider");return t},Ce=t=>{const{search:r,setSearch:n}=N();return o(h,{...t,children:[o(f,{my:"4",pl:"3",justifyContent:"space-between",alignItems:"center",children:[e(U,{as:"h2",fontSize:"md",fontWeight:"medium",ml:"9",children:"\u0627\u0644\u062F\u0631\u062F\u0634\u0627\u062A"}),o(ce,{maxW:"230px",size:"sm",children:[e(de,{pointerEvents:"none",children:e(ie,{color:"gray.300"})}),e(H,{type:"text",onChange:c=>n(c.target.value),value:r,placeholder:"\u0628\u062D\u062B \u0628\u0648\u0627\u0633\u0637\u0629 \u0627\u0644\u0627\u0633\u0645...",borderRadius:"md"})]})]}),e(he,{children:e(me,{isActive:!0,variant:"ghost",size:"sm",children:"\u0627\u0644\u0643\u0644"})})]})},we=({fullname:t,lastMessage:r})=>{const{userStore:{me:n}}=v(),s=(n==null?void 0:n.fullname)===t;return e(h,{mr:"4",maxW:"200px",children:o(g,{fontWeight:"semibold",children:[s?"\u0627\u0644\u0631\u0633\u0627\u0626\u0644 \u0627\u0644\u0645\u062D\u0641\u0648\u0638\u0629":t," ",e("br",{}),r&&o(g,{as:"span",fontWeight:"normal",fontSize:"sm",color:"gray.500",wordBreak:"break-all",children:[r.from===(n==null?void 0:n.id)&&"You: ",r.content.length>=20?r.content.slice(0,20-1)+"...":r.content]})]})})},Ie=({time:t})=>e(h,{alignSelf:"flex-end",mr:"auto",children:e(g,{as:"span",color:"gray.500",children:t})}),Me=({fullname:t,isOnline:r})=>{const{userStore:{me:n}}=v(),s=(n==null?void 0:n.fullname)===t;return e(F,{children:e(j,{name:s?void 0:t,bg:s?"blue.400":void 0,icon:e(Z,{color:"white"}),size:"md",children:!s&&e(fe,{boxSize:"0.90em",bg:r?"green.500":"red.500"})})})},d=t=>{const r=P(),n=ee(),s=new URLSearchParams(n.search).get("chat_id"),c=L("gray.50","gray.700");return e(h,{onClick:()=>{r.replace({pathname:n.pathname,search:new URLSearchParams({chat_id:t.id}).toString()})},py:"5",px:"4",borderRadius:"lg",bg:s===t.id?c:"",_hover:{bg:c},transition:"all .1s",cursor:"pointer",children:e(f,{flexDir:"row",alignItems:"center",children:t.children})})};d.Avatar=Me;d.Info=we;d.Time=Ie;const E=({children:t})=>e(O,{mt:"12",maxH:"690px",overflowY:"scroll",pr:{base:"0",lg:"3"},minWidth:{base:"auto",lg:"300px"},children:t}),Ae=R(()=>{const{userStore:{me:t},onlineStore:r}=v(),{data:n}=be(),{search:s}=N();if(n===null||t===null)return o(E,{children:[e(z,{h:"90px",borderRadius:"lg"}),e(z,{h:"90px",borderRadius:"lg"})]});const c=(s?n.filter(a=>a.fullname.toLocaleLowerCase().includes(s)):n).concat().sort((a,b)=>new Date(b.lastMessage.time).valueOf()-new Date(a.lastMessage.time).valueOf()),x=c.length===0;return o(E,{children:[o(d,{id:t.id,children:[e(d.Avatar,{isOnline:!0,fullname:t.fullname}),e(d.Info,{fullname:t.fullname})]}),!x&&c.map(a=>a.userId!==t.id&&o(d,{id:a.userId,children:[e(d.Avatar,{isOnline:r.isOnline(a.userId)||!1,fullname:a.fullname}),e(d.Info,{fullname:a.fullname,lastMessage:a.lastMessage}),e(d.Time,{time:new Date(a.lastMessage.time).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]},a.userId))]})}),D=t=>e(_,{pt:"7rem",px:{base:"0",lg:"3"},...t,children:t.children});D.Heading=Ce;D.Users=Ae;const Le=u.exports.memo(({fullname:t})=>e(F,{alignSelf:"flex-start",children:e(j,{name:t,size:"sm"})})),G=u.exports.createContext(void 0),De=()=>{const t=u.exports.useContext(G);if(!t)throw new Error("MessageContext was outside of its provider");return t},Te=({content:t,time:r})=>{const{isMyMessage:n}=De(),s=n?L("gray.100","gray.600"):L("gray.50","gray.700");return e(h,{mx:"4",maxW:"450px",bg:s,borderRadius:"3xl",px:"6",py:"3",children:o(g,{fontSize:"15px",wordBreak:"break-all",children:[t,e(h,{as:"time",userSelect:"none",position:"relative",left:"10px",float:"left",top:"8px",alignSelf:"flex-end",color:"gray.500",fontSize:"xs",dateTime:r,children:r})]})})},ke=u.exports.memo(({messages:t})=>{const r=u.exports.useRef(null);return u.exports.useEffect(()=>{r.current&&r.current.scrollTo(0,r.current.scrollHeight)},[t]),e(O,{ref:r,h:"65vh",overflowY:"scroll",mb:"12",mt:"6",spacing:"3",pr:"8",children:t.length!==0?t.map((n,s)=>o(S,{isMyMessage:n.isMyMessage,children:[e(S.Avatar,{fullname:n.userName}),e(S.Text,{content:n.content,time:n.time})]},s)):e(h,{children:e(g,{mt:"5",textAlign:"center",color:"gray.500",userSelect:"none",children:"\u0633\u062A\u0638\u0647\u0631 \u0627\u0644\u0631\u0633\u0627\u0626\u0644 \u0647\u0646..."})})})}),S=({children:t,isMyMessage:r})=>e(G.Provider,{value:{isMyMessage:r},children:e(f,{flexDir:r?"row-reverse":"row",alignItems:"center",children:t})});S.Avatar=Le;S.Text=Te;const A=t=>e(_,{pt:"7rem",pb:"5",px:{base:"4",lg:"12"},...t,children:t.children}),We=t=>{const{userStore:{me:r},onlineStore:n}=v(),s=new URLSearchParams(location.search).get("chat_id"),[c,x]=u.exports.useState(!1),[a,b]=u.exports.useState(null),[C,T]=u.exports.useState(""),[V,w]=u.exports.useState([]),{socket:I}=u.exports.useContext(te),Y=P(),q=ge(),k=(r==null?void 0:r.id)===(a==null?void 0:a.id),J=i=>{if(i.preventDefault(),C===""||r===null)return;const l={userName:r.fullname,content:C,time:new Date().toLocaleTimeString(),isMyMessage:!0};s&&(I==null||I.emit("chat:message",{content:l.content,to:s}),w(p=>[...p,l]),T(""))},K=i=>T(i.target.value);return u.exports.useEffect(()=>{s&&(async()=>{var i;try{x(!0);const{data:l}=await W.fetchUserById(s),{data:{history:p}}=await W.fetchChatHistory(s),M=p.map(y=>({isMyMessage:y.from===(r==null?void 0:r.id),content:y.content,time:new Date(y.time).toLocaleTimeString(),userName:y.from===(r==null?void 0:r.id)?r==null?void 0:r.fullname:l.fullname}));b(l),w(M)}catch(l){re.isAxiosError(l)&&((i=l.response)==null?void 0:i.status)===404&&(q({title:"\u0644\u0645 \u064A\u062A\u0645 \u0625\u064A\u062C\u0627\u062F \u0627\u0644\u0645\u062D\u0627\u062F\u062B\u0629.",status:"warning"}),Y.replace({search:""})),console.error(l)}finally{x(!1)}})()},[s]),ne("chat:message",i=>{const l=n.getUser(i.from);if(l&&s===i.from){if(i.to===i.from)return;const p={content:i.content,userName:l.userName,isMyMessage:!1,time:new Date(i.time).toLocaleTimeString()};w(M=>[...M,p])}}),c?e(A,{children:e(ye,{})}):!s||!a?e(A,{children:o(h,{textAlign:"center",mt:{base:"0",lg:"15rem"},children:[e(le,{as:se,color:"gray.600",w:"16",h:"16"}),e(g,{color:"gray.500",userSelect:"none",children:"\u0627\u062E\u062A\u0631 \u0627\u0644\u0645\u062D\u0627\u062F\u062B\u0629 \u0644\u0628\u062F\u0621 \u0627\u0644\u062A\u0648\u0627\u0635\u0644"})]})}):e(A,{...t,children:o(f,{flexDir:"column",children:[o(f,{my:"3",alignItems:"flex-end",justifyContent:"space-between",children:[e(U,{as:"h2",fontWeight:"semibold",fontSize:"3xl",children:k&&r?"\u0627\u0644\u0631\u0633\u0627\u0626\u0644 \u0627\u0644\u0645\u062D\u0641\u0648\u0638\u0629":a.fullname}),!k&&e(xe,{as:ae,to:`/user/${a.id}`,textDecor:"underline",children:"\u0639\u0631\u0636 \u0627\u0644\u0645\u0644\u0641 \u0627\u0644\u0634\u062E\u0635\u064A"})]}),e(pe,{my:"2"}),e(ke,{messages:V}),e("form",{onSubmit:i=>J(i),children:o(f,{mt:"auto",alignItems:"flex-end",children:[e(H,{onChange:K,value:C,resize:"block",type:"text",placeholder:"\u0643\u062A\u0627\u0628\u0629 \u0631\u0633\u0627\u0644\u0629...",variant:"outline",rounded:"xl",mr:"2"}),e(Se,{type:"submit",icon:e(oe,{}),"aria-label":"\u0625\u0631\u0633\u0627\u0644",variant:"ghost",_hover:{bg:"inherit"},_active:{bg:"inherit"},_focus:{outline:"none"}})]})})]})})},Be=({children:t})=>{const[r,n]=u.exports.useState("");return e($.Provider,{value:{search:r,setSearch:n},children:t})},m=t=>e(Be,{children:e(ve,{gridTemplateColumns:{base:"1fr",lg:"1fr 3fr"},h:"100vh",...t,children:t.children})});m.Sidebar=D;m.Window=We;const ze=()=>{const{userStore:{me:t}}=v();return t===null?e(ue,{}):e(B,{maxW:"100%",mt:"0",mb:"0",children:e(B.Content,{children:o(m,{children:[o(m.Sidebar,{children:[e(m.Sidebar.Heading,{}),e(m.Sidebar.Users,{})]}),e(m.Window,{})]})})})};var Fe=R(ze);export{Fe as default};
